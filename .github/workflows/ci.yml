name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Go quality checks (test + lint)
  go-check:
    uses: duyhenryer/shared-workflows/.github/workflows/go-check.yml@main
    with:
      command-test: 'go test -race -coverprofile=coverage.out ./...'
      lint: true
    secrets: inherit

  # SonarCloud analysis
  sonar:
    needs: go-check
    uses: duyhenryer/shared-workflows/.github/workflows/sonarqube.yml@main
    with:
      project-key: 'duynhne_user-service'
      organization: 'duynhne'
    secrets: inherit
    permissions:
      contents: read
      pull-requests: read

  # Docker build and push (only on main)
  docker:
    needs: go-check
    if: github.ref == 'refs/heads/main'
    uses: duyhenryer/shared-workflows/.github/workflows/docker-build.yml@main
    with:
      image-name: 'user-service'
      push: true
    secrets: inherit
    permissions:
      contents: read
      packages: write
      id-token: write
