name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  packages: write
  pull-requests: read
  id-token: write
  actions: read
  security-events: write

jobs:
  # 1. PR Checks (Branch Name + Slack "PR Opened")
  pr-checks:
    if: github.event_name == 'pull_request'
    uses: duyhenryer/shared-workflows/.github/workflows/pr-checks.yml@main
    with:
      slack_channel_id: "C0AD82A9A74"
    secrets:
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

  # 2. Test & Lint
  go-check:
    uses: duyhenryer/shared-workflows/.github/workflows/go-check.yml@main
    with:
      command-test: 'go test -race -coverprofile=coverage.out ./...'
      lint: true
    secrets: inherit

  # 3. Analysis
  sonar:
    needs: go-check
    uses: duyhenryer/shared-workflows/.github/workflows/sonarqube.yml@main
    with:
      project-key: 'duynhne_user-service'
      organization: 'duynhne'
      fail-on-quality-gate: false
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # 4a. Build & Push (Main Only)
  docker-build:
    needs: [go-check, sonar]
    if: github.ref == 'refs/heads/main'
    uses: duyhenryer/shared-workflows/.github/workflows/docker-build-go.yml@main
    with:
      image-name: 'user'
      push: true
    secrets: inherit
    permissions:
      contents: read
      packages: write
      actions: read

  # 4b. Trivy Vulnerability Scan
  trivy-scan:
    needs: [docker-build]
    uses: duyhenryer/shared-workflows/.github/workflows/trivy-scan.yml@main
    with:
      image-ref: ghcr.io/${{ github.repository }}/user@${{ needs.docker-build.outputs.digest }}
      severity: 'CRITICAL,HIGH'
      exit-code: '1'
      ignore-unfixed: true
    secrets: inherit
    permissions:
      contents: read
      packages: read
      security-events: write

  # 4c. Cosign Signing (only after scan passes)
  docker-sign:
    needs: [docker-build, trivy-scan]
    uses: duyhenryer/shared-workflows/.github/workflows/docker-sign.yml@main
    with:
      tags: ${{ needs.docker-build.outputs.tags }}
      digest: ${{ needs.docker-build.outputs.digest }}
    secrets: inherit
    permissions:
      contents: read
      packages: write
      id-token: write

  # 4d. Build Migration Image (build only, no scan/sign)
  docker-db-init:
    needs: [go-check, sonar]
    if: github.ref == 'refs/heads/main'
    uses: duyhenryer/shared-workflows/.github/workflows/docker-build-go.yml@main
    with:
      image-name: 'user-init'
      dockerfile: 'db/migrations/Dockerfile'
      context: 'db/migrations'
      push: true
    secrets: inherit
    permissions:
      contents: read
      packages: write
      actions: read

  # 5. Final Status Notification
  notify:
    if: always()
    needs: [pr-checks, go-check, sonar, docker-build, trivy-scan, docker-sign, docker-db-init]
    uses: duyhenryer/shared-workflows/.github/workflows/status.yml@main
    with:
      slack_channel_id: "C0AD82A9A74"
      slack_thread_ts: ${{ needs.pr-checks.outputs.slack_thread_ts }}
      gsheet_spreadsheet_id: "1F2VUrAOyMGnETApp5yA-ldCW81ConiQXnWYZVxKas_0"
    secrets:
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      GSHEET_CLIENT_EMAIL: ${{ secrets.GSHEET_CLIENT_EMAIL }}
      GSHEET_PRIVATE_KEY: ${{ secrets.GSHEET_PRIVATE_KEY }}
